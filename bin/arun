#!/bin/bash
set -e

# Run a command through the agent-creds proxy
# Usage: bin/arun curl https://api.stripe.com/v1/customers -H "Authorization: Bearer $(cat /creds/stripe)"

# Use -it only if we have a TTY
TTY_FLAG=""
if [ -t 0 ]; then
  TTY_FLAG="-it"
fi

# Mount creds directory if mintfs is running (looks in current dir)
SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
CREDS_MOUNT=""
if [ -d "$SCRIPT_DIR/creds" ]; then
  # Use --mount with rslave propagation to support FUSE mounts
  CREDS_MOUNT="--mount type=bind,source=$SCRIPT_DIR/creds,target=/creds,readonly,bind-propagation=rslave"
fi

exec docker run --rm $TTY_FLAG \
  --network envoy_agent-creds \
  -u "$(id -u):$(id -g)" \
  -v "$HOME/.claude:$HOME/.claude" \
  -v "$PWD:/workspace" \
  $CREDS_MOUNT \
  -w /workspace \
  -e HOME="$HOME" \
  sandbox \
  "$@"
