#!/bin/bash
set -e

# Start an interactive dev session with the agent-creds proxy
# Usage: bin/adev

WORK_DIR="$(pwd)"
SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$SCRIPT_DIR"

# Status file for spinner message
STATUS_FILE=$(mktemp)
echo "starting" > "$STATUS_FILE"

# Spinner function - reads status from file
spinner() {
  local chars="⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏"
  while true; do
    local msg=$(cat "$STATUS_FILE" 2>/dev/null || echo "starting")
    for (( i=0; i<${#chars}; i++ )); do
      printf "\r\033[36m%s\033[0m %s" "${chars:$i:1}" "$msg"
      sleep 0.1
    done
  done
}

status() { echo "$1" > "$STATUS_FILE"; }

# Start spinner
spinner &
SPINNER_PID=$!
trap "kill $SPINNER_PID 2>/dev/null; printf '\r\033[K'; rm -f $STATUS_FILE" EXIT

# Ensure proxy is running
if ! docker compose ps --status running 2>/dev/null | grep -q envoy; then
  status "starting proxy..."
  python3 scripts/generate.py >/dev/null
  docker compose up -d --build --quiet-pull 2>&1 | grep -v "^Network\|^Container" || true
fi

# Build aenv if needed
if [ ! -f generated/aenv ] || [ cmd/aenv/main.go -nt generated/aenv ]; then
  status "building aenv..."
  (cd cmd/aenv && go build -o ../../generated/aenv .)
fi

# Build sandbox only if needed
NEEDS_BUILD=false
if ! docker image inspect sandbox >/dev/null 2>&1; then
  NEEDS_BUILD=true
elif [ claude-dev/Dockerfile -nt generated/.sandbox-built ] || \
     [ claude-dev/entrypoint.sh -nt generated/.sandbox-built ] || \
     [ generated/aenv -nt generated/.sandbox-built ] || \
     [ generated/certs/ca.crt -nt generated/.sandbox-built ] || \
     [ generated/hosts -nt generated/.sandbox-built ] || \
     [ generated/domains.json -nt generated/.sandbox-built ]; then
  NEEDS_BUILD=true
fi

if [ "$NEEDS_BUILD" = true ]; then
  status "building sandbox..."
  docker build -q -t sandbox --build-arg USER_UID=$(id -u) --build-arg USER_GID=$(id -g) \
    -f claude-dev/Dockerfile . >/dev/null
  touch generated/.sandbox-built
fi

# Mount creds directory if mintfs is running
CREDS_MOUNT=""
if [ -d "creds" ]; then
  CREDS_MOUNT="-v $SCRIPT_DIR/creds:/creds:ro"
fi

# Stop spinner and clear line
kill $SPINNER_PID 2>/dev/null
trap - EXIT
printf '\r\033[K'

docker run -it --rm \
  --network=agent-creds_agent-creds \
  -v "$WORK_DIR:/workspace" \
  -v "$HOME/.claude:/home/devuser/.claude" \
  $CREDS_MOUNT \
  sandbox
